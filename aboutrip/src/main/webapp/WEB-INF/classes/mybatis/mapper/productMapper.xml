<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="product">
	<!-- 입력 -->
	<insert id="insert_product"
		parameterType="com.aboutrip.app.product.Product">
		<selectKey keyProperty="code" resultType="int"
			order="BEFORE">
			SELECT product_seq.NEXTVAL FROM dual
		</selectKey>
		INSERT INTO product(code, product_name, product_detail, isHidden,
		sales_start, sales_end, upload_date, update_date, category_num)
		VALUES(#{code}, #{product_name}, #{product_detail}, #{isHidden},
		#{sales_start}, #{sales_end}, SYSDATE, SYSDATE, #{category_num})
	</insert>
	
	<insert id="insert_product_detail"
		parameterType="com.aboutrip.app.product.Product">
		INSERT INTO productDetail(detail_num, option_name,
		option_value, price, code, start_date, end_date)
		VALUES(product_detail_seq.NEXTVAL,
		#{option_name}, #{option_value},
		#{price}, #{code}, #{start_date}, #{end_date})
	</insert>

	<insert id="insert_product_image"
		parameterType="com.aboutrip.app.product.Product">
		INSERT INTO product_img(img_num, img_name, code)
		VALUES(product_img_seq.NEXTVAL, #{img_name}, #{code})
	</insert>

	<insert id="insert_product_review"
		parameterType="com.aboutrip.app.product.Order">
		INSERT INTO product_review(review_num, rate,
		reviewContent, user_num, order_num)
		VALUES(product_review_seq.NEXTVAL,
		#{rate}, #{reviewContent}, #{user_num}, #{order_num})
	</insert>

	<insert id="insert_product_q"
		parameterType="com.aboutrip.app.product.QnA">
		INSERT INTO product_review(num, type, title, content,
		c_date, answer, a_date, code, userNum)
		VALUES(PRODUCTQNA_SEQ.NEXTVAL,
		#{type}, #{title}, #{content}, #{c_date}, #{answer}, #{a_date},
		#{code}, #{userNum} )
	</insert>

	<update id="insert_product_a"
		parameterType="com.aboutrip.app.product.QnA">
		UPDATE product_review SET(answer, a_date)
		VALUES(#{answer}, #{a_date})
		WHERE num = #{num}
	</update>

	<insert id="cart_insert" parameterType="com.aboutrip.app.product.Order" >
		INSERT INTO cart(cart_num, user_num, quantity, detail_num)
		VALUES(cart_seq.NEXTVAL, #{user_num}, #{quantity}, #{detail_num})
	</insert>
	
	<!-- 수정 -->
	<update id="update_product"	parameterType="com.aboutrip.app.product.Product">
		UPDATE product SET product_name = #{product_name}, product_detail = #{product_detail}, isHidden = {isHidden},
		sales_start = #{sales_start}, sales_end=#{sales_end}, upload_date=#{upload_date}, update_date=#{update_date}, category_num=#{category_num}
		WHERE code = #{code}
	</update>
	
	<update id="update_product_detail"	parameterType="com.aboutrip.app.product.Product">
		UPDATE productdetail SET option_name=#{option_name}, price=#{price}, start_date=#{start_date}, end_date=#{end_date}
		WHERE detail_num = #{detail_num}
	</update>

	<insert id="update_product_image"
		parameterType="com.aboutrip.app.product.Product">
		UPDATE product_img SET img_name = #{img_name} WHERE img_num = #{img_num}
	</insert>

	<!-- 삭제 -->
	<delete id="delete_product" parameterType="Integer">
		DELETE FROM product WHERE code=#{code}
	</delete>
	
	<delete id="delete_product_img" parameterType="Integer">
		DELETE FROM product_img WHERE code=#{code}
	</delete>
	
	<delete id="delete_product_detail" parameterType="Integer">
		DELETE FROM productdetail WHERE code=#{code}
	</delete>

	<delete id="delete_product_detail2" parameterType="Integer">
		DELETE FROM productdetail WHERE detail_num=#{detail_num}
	</delete>
	
	<delete id="delete_cart" parameterType="Integer">
		DELETE FROM cart WHERE user_num=#{user_num}
	</delete>
	
	<!-- 리스트 -->
	<select id="product_list_categories" parameterType="map"
		resultType="com.aboutrip.app.product.Product">
		SELECT p.code, product_name, TO_CHAR(sales_start,'YYYY-MM-DD') sales_start, TO_CHAR(sales_end, 'YYYY-MM-DD') sales_end, upload_date,ishidden, price, img_name
		FROM product p
		LEFT JOIN (SELECT code, MIN(price) price FROM productdetail GROUP BY code)d ON p.code=d.code
		JOIN product_img i ON p.code=i.code
		WHERE category_num IN
		<foreach collection="list" item="code" index="index"
			separator="," open="(" close=")">
			#{code}
		</foreach>
		AND sales_end > SYSDATE
		ORDER BY sales_start ASC
		OFFSET #{offset} ROWS FETCH FIRST #{rows} ROWS
		ONLY
	</select>

	<select id="product_list_event" parameterType="Integer"
		resultType="com.aboutrip.app.product.Product">
		SELECT p.code, product_name, TO_CHAR(sales_start,'YYYY-MM-DD') sales_start, TO_CHAR(sales_end, 'YYYY-MM-DD') sales_end, upload_date,ishidden, price, img_name
		FROM product p
		LEFT JOIN (SELECT code, MIN(price) price FROM productdetail GROUP BY code)d ON p.code=d.code
		JOIN product_img i ON p.code=i.code
		WHERE category_num = #{category_num}
		AND sales_end > SYSDATE
		ORDER BY sales_start ASC
	</select>
	
	<select id="product_management_list" resultType="com.aboutrip.app.product.Product">
		SELECT code, product_name, category_num, TO_CHAR(sales_start,'YYYY-MM-DD') sales_start, TO_CHAR(sales_end,'YYYY-MM-DD') sales_end, isHidden
		FROM product
		ORDER BY code DESC
	</select>
	
	<select id="option_list" parameterType="Integer" resultType="com.aboutrip.app.product.Product">
		SELECT detail_num, option_name, option_value, price, start_date, end_date
		From productdetail
		WHERE code=#{code}
	</select>
	
	<select id="option_management_list" resultType="com.aboutrip.app.product.Product">
		SELECT detail_num, option_name, option_value, price, start_date, end_date, code
		From productdetail
	</select>
	
	<select id="cartlist" resultType="com.aboutrip.app.product.Order">
		SELECT cart_num, quantity, price, option_name, product_name
		FROM cart c
		JOIN productDetail d ON c.detail_num = d.detail_num
		JOIN product p ON d.code = p.code
		WHERE user_num = #{user_num}
	</select>
	
	<!-- 글 -->
	
	<select id="product_read" parameterType="Integer"
		resultType="com.aboutrip.app.product.Product">
		SELECT p.code, product_name, product_detail, TO_CHAR(sales_start,'YYYY-MM-DD') sales_start, TO_CHAR(sales_end,
		'YYYY-MM-DD') sales_end, upload_date,
		ishidden, category_num, img_name
		FROM product p
		JOIN product_img i ON p.code = i.code
		WHERE
		p.code=#{code}
	</select>
	
	<select id="detail_read" parameterType="Integer" resultType="com.aboutrip.app.product.Product">
		SELECT option_name, option_value, price, start_date, end_date, code
		From productdetail
		WHERE detail_num=#{detail_num}
	</select>
	
	<!-- 카운트 -->
	<select id="list_count" parameterType="map" resultType="Integer">
		SELECT NVL(COUNT(*), 0)
		FROM product
		WHERE category_num IN
		<foreach collection="list" item="code" index="index"
			separator="," open="(" close=")">
			#{code}
		</foreach>
	</select>

	<select id="option_count" parameterType="Integer"
		resultType="Integer">
		SELECT NVL(COUNT(*), 0)
		FROM productdetail
		WHERE code=#{code}
	</select>
	
	<select id="cart_count" parameterType="Integer"
	resultType="Integer">
		SELECT NVL(COUNT(*), 0)
		FROM cart
		WHERE user_num = #{user_num}
	</select>

	
	
</mapper>